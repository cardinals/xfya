/**
 * 3D 文件加载
 */
uModel.OnLoadComplete = function () {
	uModel.LoadScriptString('State = ' + Ddd.instance.state);
	uModel.LoadScriptString(`// 初始化状态、注册事件、内存变量、全局方法

BoxCollider = import_type("UnityEngine.BoxCollider");
MeshCollider = import_type("UnityEngine.MeshCollider");

Camera = import_type("UnityEngine.Camera");
Bounds = import_type("UnityEngine.Bounds");
RenderTexture = import_type("UnityEngine.RenderTexture");
Canvas = import_type("UnityEngine.Canvas");
RawImage = import_type("UnityEngine.UI.RawImage");
CameraClearFlags = import_type("UnityEngine.CameraClearFlags");
ObjectUtil = import_type("Uinnova.ObjectUtil");

stateManager = import_type("Uinnova.StateManager").Instance;

// zxh
UIMenu = import_type("Uinnova.UIMenu");
UIMenuItem = import_type("Uinnova.UIMenuItem");
popMenu = import_type("Uinnova.PopMenu").Instance;
uiHandle = import_type("Uinnova.UIHandle").Instance;
CurveLine = import_type("Uinnova.CurveLine");
txtPanel = import_type("Uinnova.TextSetPanel").Instance;
linePanel = import_type("Uinnova.LineSetPanel").Instance;
stateMgr = import_type("Uinnova.StateManager").Instance;
measureTool = import_type("Uinnova.MeasureTool").Instance;
fxManager = import_type("Uinnova.SelectEffectManager");
effectBoxSelect = import_type("Uinnova.BoxSelectEffect");

scriptConsole = import_type("Uinnova.ScriptConsole").Instance;
scriptConsole.OpenCatch = false;  // 控制台捕捉异常： 关闭

// ui初始化，编辑中，对物体生成小菜单
var __UI_INIT__ = function() {
	uiHandle.AddShowType(ObjectFactory.CLS_PLACEMENT);
	// 按钮操作结束回调
	uiHandle.OnComplete = function(objs) {
		/*for (var i = 0; i < objs.Count; i++) {
			var obj = objs.get_Item(i);
		}*/
		if(objs.Count>0){
			var obj = objs.get_Item(0);
			CallJS(true, {funcid: "complete", data: ParseJson(obj)});
		}
	};
}

if(!State) {
	__UI_INIT__();
	fxManager.SetEffectManager(ObjectFactory.CLSID_PLACEMENT, fxManager.SelectEffectType.BoxWire);
	effectBoxSelect.SetColorSetting(Color.red, Color.green);	
}

util.addEventListener("levelchange", function(event) {
	var objs =  object.findByProperty("uiKey");
	for (var j = 0; j < objs.Count; j ++){
		var obj = objs.get_Item(j);
		var uiKey = obj.getProperty("uiKey");
		if(uiKey == 'false') {
			obj.PickEnabled = false;
		}
	}
})/**
 * 定义 call js interface
 * @author yf_d
 * @date 2017-10-23 14:42:28
 */
CallJS = function (state, data) {
	util.externalCall('Ddd.then', {state: state, data: data});
}
/**
 * 将3D物体数据转换成json数据
 * @todo 需要经常关注新增属性和删除属性
 * @desc Cls 类别可以参考 ObjectFactory.cs，目前用的较多的有以下几种
 * // 世界 'World' // 建筑 'Building' // 楼层 'FloorPlan' // 物体 'Placement' // 物体组 'PlacementGroup'
 * // 文字 'Text3D' // 曲线 'CurveLine' // 箭头线 'ArrowLine' // 管状线 'PipeLine' // 区域 'Polygon'
 */
ParseJson = function (obj) {
	var data = {},
		props = {},
		scale,
		bundle;

	foreach(var i in pairs(obj.props)) {
		props[i.Key] = i.Value;
	}
	
	var pos = [obj.transform.localPosition.x, obj.transform.localPosition.y, obj.transform.localPosition.z];
	var rot = [obj.transform.localRotation.x, obj.transform.localRotation.y, obj.transform.localRotation.z, obj.transform.localRotation.w];

	// 排除没有 BundleId 的类型
	//if (obj.Cls != 'Text3D' && obj.Cls != 'CurveLine' && obj.Cls != 'ArrowLine' && obj.Cls != 'World' && obj.Cls != 'Building' && obj.Cls != 'FloorPlan' && obj.Cls != 'Floor' && obj.Cls != 'LongCurveLine' && obj.Cls!= 'PixelLine') {
	if (obj.Cls != 'Text3D' && string.indexof(obj.Cls, "Line") == -1 && obj.Cls != 'Polygon' && obj.Cls != 'World' && obj.Cls != 'Building' && obj.Cls != 'FloorPlan' && obj.Cls != 'Floor') {
		bundle = obj.BundleId;
	}

	// 排除没有 缩放 的类型
	if (obj.Cls != 'Text3D' && string.indexof(obj.Cls, "Line") == -1 && obj.Cls != 'Polygon' && obj.Cls != 'World' && obj.Cls != 'Building' && obj.Cls != 'FloorPlan' && obj.Cls != 'Floor') {
		scale = [obj.getScale().x, obj.getScale().y, obj.getScale().z];
	}

	data = {
		"type": obj.Cls,
		"id": obj.uid,
		"name": obj.name,
		"props": props,
		"pos": pos,
		"rot": rot,
		"scale": scale,
		"bundleId": bundle,
		"parentId": obj.parent ? obj.parent.id : 'null'
	};
	return data;
}
/**
 * 声明一个公共的方法类库
 */
if (!is_table(U)) {
	U = {};
}
/**
 * 坐标转换 coordinate transformation
 * @author haaid
 * @date 2017-10-30 10:02:31
 * @example [0,1] -> Vector2(0,1)
 * @example Vector2(0,1) -> [0,1]
 * @example [9,9,9] -> Vector3(9,9,9)
 * @example Vector3(0,0,0) -> [0,0,0]
 */
U.CT = function(pos) {
	// 如果坐标是数组类型
	if (type(pos) == 5) {
		if (array.count(pos) == 3) {
			return Vector3(pos[0], pos[1], pos[2]);
		}
		return Vector2(pos[0], pos[1]);
	} else {
		if (typeof(pos) == Vector3) {
			return [pos.x, pos.y, pos.z];
		}
		return [pos.x, pos.y];
	}
}
/**
 * 将3D日志打印到浏览器控制台
 */
U.log = function (msg, lv) {
	CallJS(true, { funcid: 'console', data: { 'msg': msg, 'lv': lv } });
}/**
 * 物体查询
 * @author haaid
 * @date 2017-10-31 10:28:38
 * @desc 简单写个 Q 方法，代替原来的 S，因为原来的不支持 ID 查询
 */
_Q = function (sel, cat) {
	if (!cat) cat = 'uid';
	return _curd.r(sel, cat);
}
/**
 * CURD 操作
 * @author haaid
 * @date 2017-11-1 17:55:49
 * @desc 创建（Create）、更新（Update）、读取（Retrieve）、删除（Delete）
 */
_curd = {
	points: {}
	c: function(param, fun) {
		// Thing
		if (param.type == 'Thing') {
			if (!param.idType) return U.log('Thing 类型必须传递 idType 参数！(DddUS)', 'error');

			var bundleId = param.idType,
				position = param.pos ? U.CT(param.pos) : Vector3(0, 0, 0),
				scale = param.size ? U.CT(param.size) : Vector3(1, 1, 1),
				uiKey = param.uiKey || false;

			object.create(bundleId, function(o) {
				o.uid = param.id;
				
				if (param.pid) {
					var parent = object.findId(param.pid);
					if (parent)
						o.parent = parent;
				}
				if (param.name)
					o.name = param.name;
				// 遍历attr，设置attr
				if (param.attr) {
					foreach(var item in pairs(param.attr)) {
						jsi.attr(o.uid, item.key, item.value);
					}
				}
				// 遍历style， 设置style
				if (param.style) {
					foreach(var item in pairs(param.style)) {
						var tmp = type(item.value) != 2 ? json.encode(item.value) : item.value;
						jsi.thing.style[item.key](o.uid, tmp);
					}
				}
			
				if(param.uiKey){
					selector.addCandidate(o);
					selector.ClearSelection();
					selector.select(o);
				}
				o.addProperty("uiKey", uiKey + '');
				// 返回
				fun(ParseJson(o));
			}, position, scale);
		}
		// Bubble
		else if (param.type == 'Bubble') {
			if (!param.style) param.style = {};
			if (!param.idType) param.idType = 'empty';
			// if (!param.style['background-image']) return;

			var url = param.url,
				style = param.style,
				depend;

			function init_bubble(res) {
				var objList = _Q(param.depend);
				if(array.count(objList) == 0) {
					print('查找不到的ID：'+ param.depend);
					return;
				}
				foreach(var item in pairs(objList)) {
					var obj = item.value;
					if (!obj || _map.bubble[obj.uid]) continue;

					var ui = gui.create(res);
					// 设置气泡颜色
					var clr = style.color;
					if (type(clr) == 5) {
						ui.setImageColor("Button", Color(clr[0], clr[1], clr[2]));
					}
					// 设置气泡图片
					var img = style.image ? style.image : style['background-image'];
					if (img) {
						if (_map.bubbleImg[img]) {
							ui.setImage("Button", _map.bubbleImg[img]);
						} else {
							util.downloadTexture({
								'url': img,
								'success': function (tex) {
									_map.bubbleImg[img] = tex;
									ui.setImage("Button", tex);
								}
							});
						}
					}
					// 设置气泡位置
					var offsetX = type(param.pos) == 5 ? param.pos[0] : 0,
						offsetY = type(param.pos) == 5 ? param.pos[1] : 0,
						offsetZ = type(param.pos) == 5 ? param.pos[2] : 0;
					offsetY = (obj.getScale ? obj.size.y * obj.getScale().y : obj.size.y) + offsetY;
					ui.setObject(obj, Vector3(offsetX, offsetY, offsetZ));
					// 设置气泡缩放
					var scale = style.scale;
					if (type(scale) == 5) {
						ui.setScale(scale[0], scale[1]);
					}
					// 设置气泡文字
					var text = style.text;
					if (text) {
						text = string.replace(text, '<br>', '\\n');
						text = string.replace(text, '<br/>', '\\n');
						text = string.replace(text, '<br />', '\\n');
						ui.setText('Button/Text', text);
					}
					// 设置气泡文字大小
					var textSize = style.textSize;
					if (textSize) {
						var textUI = ui.findText('Button/Text');
						textUI.fontSize = textSize;
					}
					// 设置气泡文字颜色
					var textColor = style.textColor;
					if (type(textColor) == 5) {
						ui.setTextColor('Button/Text', Color(textColor[0], textColor[1], textColor[2]));
					}
					// 判断buddleType 是否存在
					var buddleType = param.buddleType;
					if(buddleType){
						ui.findImage("Button/" + buddleType).gameObject.SetActive(true);	
					}
					// 缓存
					_map.bubble[obj.uid] = ui;
					depend = obj.uid;
				}
				// 返回
				fun({
					'type': 'Bubble',
					'depend': ParseJson(_Q(depend)[0])
				});
			}
			if (!url) {
				init_bubble(_map.res[param.idType]);
			}
			else {
				util.download({
					'url': url,
					'success': init_bubble
				});
			}
		}
		// Text
		else if (param.type == 'Text') {
			
		}
		// Line/ArrowLine/PipeLine
		else if (param.type == 'Line' || param.type == 'ArrowLine' || param.type == 'PipeLine' || param.type == 'LongLine' || param.type == 'PixelLine') {
			if (!param.style) param.style = {};
			if (!param.points) return U.log('Line 类型必须传递 points 参数！(DddUS)', 'error');
			var tempId = param.tempId;
			var points = Vector3List();
			if(table.containskey( _curd.points , tempId )){
				points = _curd.points[tempId];
			} else {
				_curd.points[tempId] = points;
			}
			for (var i = 0; i < param.points.length; i++)
				points.Add(U.CT(param.points[i]));
			if(param.lazy && !param.start)
				return;

			// 坐标
			var position = _curd.points[tempId];
			table.remove( _curd.points , tempId );// 清除缓存
			// 宽度
			var width = param.size ? param.size : 1;
			var widthArrow = width * 3;
			if (param.style.width) {
				width = param.style.width;
			}
			if (param.style.widthArrow) {
				widthArrow = param.style.widthArrow;
			}
			// 颜色
			var clr = '',
				clrArrow = '';
			if (param.idType) {
				clr = param.idType;
			}
			if (param.style.image) {
				clr = param.style.image;
			} else if (param.style.color) {
				var arr = param.style.color;
				clr = Color(arr[0], arr[1], arr[2]);
			}
			clrArrow = clr;
			if (param.style.imageArrow) {
				clrArrow = param.style.imageArrow;
			} else if (param.style.colorArrow) {
				var arr = param.style.colorArrow;
				clrArrow = Color(arr[0], arr[1], arr[2]);
			}

			var line,
				parent;
			// Line
			if (param.type == 'Line') {
				if (param.pid)
					parent = object.findId(param.pid);

				line = object.createCurveLine(position, {'color': clr}, parent, width);
			}
			// ArrowLine
			if (param.type == 'ArrowLine') {
				var jsonParam = {
					'color': clr,
					'arrowColor': clrArrow,
					'width': width,
					'arrowWidth': widthArrow
				};
				if (param.pid)
					jsonParam.parentId = param.pid;

				line = object.createArrowLine(position, jsonParam);
			}
			// PipeLine
			if (param.type == 'PipeLine') {

			}
			// LongLine
			if(param.type == 'LongLine'){
				var jsonParam = {
					"color":clr
				};
				//line = object.createLongCurveLine(position, jsonParam);
				line = object.createLongMeshLine(position, jsonParam);
			}
			//像素线
			if(param.type == 'PixelLine'){
				var jsonParam = {
					"color":clr
				};
				line = object.createLongMeshLine(position, jsonParam);
			}
			if (!line) return;

			// 属性
			line.uid = param.id;
			if (param.attr) {
				foreach(var item in pairs(param.attr)) {
					jsi.attr(line.uid, item.key, item.value);
				}
			}
			// 动画
			var speed = param.style.speed;
			if (speed) {
				line.EnableDynamicExtensionAnim = true;
				line.StartDynamicExtensionAnim();
				line.DynamicExtensionAnimSpeed = line.length / speed;
			}
			// 返回
			fun(ParseJson(line));
		}
		// Polygon
		else if (paray.type == 'Polygon') {

		}
	},
	u: function(param, fun) {

	},
	/**
	 * 物体查询
	 * @author haaid
	 * @date 2017-11-2 10:01:38
	 * @param {String|Array|Object} sel 选择器
	 * @param {String} cat 查询类型（id/uid/class/props）
	 * @desc 选择器支持传递字符串、数组、对象类型
	 */
	r: function(sel, cat) {
		// 如果传递的选择器不是数组或对象，则包装成数组，这样就支持字符串了
		if (type(sel) != 5 && type(sel) != 6) {
			sel = [sel];
		}
		// 如果传递的类型不是字符串，则默认查询 uid
		if (type(cat) != 3) {
			cat = 'uid';
		}

		var objList = [];

		// id & uid
		if (cat == 'id' || cat == 'uid') {
			foreach(var item in vpairs(sel)) {
				if (string.length(item)) {
					// id & uid
					var tmpObj = cat == 'id' ? object.findId(item) : object.find(item);
					// add to array
					if (tmpObj) {
						array.add(objList, tmpObj);
					}
				}
			}
		}
		// class
		else if (cat == 'class') {

		}
		// props
		else if (cat == 'props') {
			foreach(var item in pairs(sel)) {
				// key & key = value
				var tmpList = [];
				if (type(item.value) == 3) {
					tmpList = object.findByProperty(item.value);
					// add to array
					if (tmpList.Count) {
						for (var i = 0; i < tmpList.Count; i++) {
							array.add(objList, tmpList.get_Item(i));
						}
					}
				}
				if (type(item.value) == 6) {
					foreach (var i in pairs(item.value)) {
						tmpList = object.findByProperty(i.key, i.value)
						// add to array
						if (tmpList.Count) {
							for (var i = 0; i < tmpList.Count; i++) {
								array.add(objList, tmpList.get_Item(i));
							}
						}
					}
				}
			}
		}

		return objList;
	},
	d: function (sel, fun) {
		var objList = _Q(json.decode(sel));

		foreach(var item in pairs(objList)) {
			var obj = item.value;
			// 删除物体的气泡
			if (_map.bubble[obj.uid]) {
				_map.bubble[obj.uid].destroy();
				table.remove(_map.bubble, obj.uid);
			}
			// 删除物体
			try{
				obj.destroy();
			}catch(e){
				objectManager.DestroyObject(obj);
			}
		}

		fun(true);
	}
}/**
 * 地图映射
 * @author haaid
 * @date 2017-11-3 10:44:57
 * @desc 将无法返回给JS层的物体，进行一个ID映射，方便操作
 */
_map = {
	/**
	 * 默认 Bundle
	 * @desc 默认提供的 bundle，自动下载
	 */
	res: {
		'empty': 'resource/gui/empty_button.bundle',
		'balloon': 'resource/gui/balloon_button.bundle',
		'message': 'resource/gui/message_button.bundle',
		'outline': 'resource/gui/outline_button.bundle'
	},
	/**
	 * 气泡映射
	 * obj.uid  ui
	 * 123123   气泡实例
	 * 456456   气泡实例
	 */
	bubble: {},
	/**
	 * 缓存气泡背景图
	 * img.src     tex
	 * path/1.png  tex
	 */
	bubbleImg: {}
}

foreach(var item in pairs(_map.res)) {
	util.download({
		'url': item.value,
		'success': function (res) {
			_map.res[item.key] = res;
		}
	});
}/**
 * 属性挂载
 * @author haaid
 * @date 2017-10-26 17:06:07
 */
_mount = {
	bind: function(method, fun) {
		if (_mount[method]) {
			fun(_mount[method]());
		}
	},
	/**
	 * 建筑信息绑定
	 */
	buildings: function() {
		var build = [];
		foreach (var bd in pairs(world.buildingList)) {
			var props = {},
				floor = [];
			foreach (var i in pairs(bd.props)) {
				props[i.Key] = i.Value;
			}
			for (var i = 0; i < bd.planList.Count; i++) {
				var plan = bd.planList.get_Item(i);
				array.add(floor, { "id": plan.ID, "name": plan.name, "height": plan.Height, "dispersion": plan.getPosition().y});
			}
			array.add(build, {"id": bd.ID, "name": bd.name, "props": props, "floors": floor});
		}
		return {
			'type': 'Floor',
			'buildings': build
		}
	},
	/**
	 * 摄影机绑定
	 */
	cam: function() {
		var arr = camera.getEyePos();
		var targetArr = camera.getTargetPos();
		return {
			'type': 'Camera',
			'camera': {
				"self": [arr[0], arr[1], arr[2]],
				"target":[targetArr[0], targetArr[1], targetArr[2]]
			}
		}
	}
}/**
 * 事件支持类型
 * @author yf_d
 * @author haaid
 * @date 2017-10-25 15:07:58
 */
Event = function() {
	// 支持的事件类型
	var _usableType = {dblclick: true, click: true};
	
	// 事件.对象.回调 {"click": {"id": "fun_name"}}
	var _eoc = {};
	
	// 利用ID进行 bind 可以扩展
	var _bind = function(etype, ID, fun) {
		if (!_usableType[etype]) {
			Log('不支持绑定事件类型：' + etype + '(DddUS)');
		}
		if (!_eoc[etype]) {
			_eoc[etype] = {};
		}
		_eoc[etype][ID] = fun;
	}
	var _unbind = function(etype, ID) {
		if (!_usableType[etype]) {
			Log('不支持解绑事件类型：' + etype + '(DddUS)');
		}
		var _etype = _eoc[etype];
		if (_etype) {
			// 干掉该属性
			table.remove(_etype, ID);
		}
	}

	// 全局绑定事件
	foreach (var i in pairs(_usableType)) {
		
		if (i.value) {
			var etype = i.key;
			util.addEventListener(etype, function(event) {
				var etypeMap = _eoc[etype];
				if (etypeMap) {
					var param = {
						type = "Event";
						// 按键 0 -> 左键; 1 -> 右键; 2 -> 中键
						button = event.button;
						// 位置
						pos = [event.pos.x, event.pos.y, event.pos.z];
						// 功能键 true/false
						alt = event.altKey;
						ctrl = event.ctrlKey;
						shift = event.shiftKey;
					}
					if (event.target) {
						var ID = event.target.ID;
						// 目标
						param['target'] = ParseJson(event.target);
						if(etypeMap[ID]){
							etypeMap[ID](param);
						}
						if(etypeMap['_globle']){
							etypeMap['_globle'](param);
						}
					} else {
						if(etypeMap['_globle']){
							etypeMap['_globle'](param);
						}
					}
				}
			})
		}
		
	}

	return {
		bind: function(eventType, objs, fun) {
			// 全局绑定
			if(type(objs) == 4){
				fun = objs;
				_bind(eventType, '_globle', fun);
			} else if (type(objs) == 5) {
				// thing bind Array
				foreach (var obj in vpairs(objs)) {
					_bind(eventType, obj.ID, fun);
				}
			} else if (type(objs) == 6) {
				// thing bind Map
				_bind(eventType, objs.ID, fun);
			}
		},
		unbind: function(eventType, objs) {
			if(objs){
				foreach (var obj in vpairs(objs)) {
					_unbind(eventType, obj.ID);
				}
			} else {
				_unbind(eventType, '_globle');
			}
		}
	}
}

_event = Event();
bundleUrl = "http://www.3dmomoda.com/mmdclient/script/examples/demos/";
// 创建鹰眼图
// 注:本DEMO代码由模模搭底层语言定制，非模模搭API编写，建议勿更改代码内容，以免出现效果不可控风险
eagleEyeOPen = {
};
eagleEyeOPen.miniMap = function (){
    Camera = import_type("UnityEngine.Camera");
    ScreenToViewportPoint = import_type("UnityEngine.ScreenToViewportPoint");

    Bounds = import_type("UnityEngine.Bounds");//边界框（包围盒）
    RenderTexture = import_type("UnityEngine.RenderTexture");
    Canvas = import_type("UnityEngine.Canvas");
    RawImage = import_type("UnityEngine.UI.RawImage");
    CameraClearFlags = import_type("UnityEngine.CameraClearFlags");

    ObjectUtil = import_type("Uinnova.ObjectUtil") ;
    RectTransformUtility = import_type("UnityEngine.RectTransformUtility");

    stateManager = import_type("Uinnova.StateManager").Instance;
    fpsPutState = import_type("UinvView.FPSPutState").Instance;
    fpsCtrlState = import_type("UinvView.FPSCtrlState").Instance;
    var b;
    var pointUi;
    shitao = {
        cube:null
        //小地图中提示点
        function CreateInspector() {

            var url = bundleUrl+"mini_map.bundle";
            pointUi = util.download({
                "url": url,
                "error":function(go){
                }
                "success": function(go) {
                        shitao.cube = GameObject.Instantiate (go, Vector3.zero, Quaternion.identity);
                        scriptManager.AddComponent(shitao.cube, clone(AutoRender));
                    }
            });
        }
        canvObj:null;
        //shitao.createImageByType(tex.width,tex.height,sp,shitao.rawImg,"rightUp");
        function createImageByType(width,height,spr,parent,type) {

                if(shitao.canvObj == null)  {
                    shitao.canvObj = GameObject();
                    var canv = shitao.canvObj.gameObject.AddComponent(Canvas);
                    canv.renderMode = RenderMode.ScreenSpaceOverlay;
                    shitao.canvObj.layer = 5;
                }
                //back image
                var imagObj = GameObject();
                imagObj.layer = 5;
                if(parent == null) {
                    imagObj.gameObject.transform.parent = shitao.canvObj.transform;
                }else{
                    imagObj.gameObject.transform.parent = parent.transform;
                }
                //image rendertexture
                var ima = imagObj.gameObject.AddComponent(Image);
                ima.sprite = spr;
                //image pos width height
                var rec = ima.gameObject.GetComponent(RectTransform);
                if(type == "leftDown"){
                    rec.anchorMax = Vector2.zero;
                    rec.anchorMin = Vector2.zero;
                    rec.pivot = Vector2.zero;
                    rec.anchoredPosition = Vector2.zero;
                    rec.sizeDelta = Vector2(width,height);
                }
                else if(type == "center"){
                    rec.anchorMax = Vector2(0.5,0.5);
                    rec.anchorMin = Vector2(0.5,0.5);
                    rec.pivot = Vector2(0.5,0.5);
                    rec.anchoredPosition = Vector2.zero;
                    rec.sizeDelta = Vector2(width,height);
                }
                else if(type == "rightDown"){
                    rec.anchorMax = Vector2(1,0);
                    rec.anchorMin = Vector2(1,0);
                    rec.pivot = Vector2(1,0);
                    rec.anchoredPosition = Vector2.zero;
                    rec.sizeDelta = Vector2(width,height);
                }
                else if(type == "rightUp"){
                    rec.anchorMax = Vector2(1,1);
                    rec.anchorMin = Vector2(1,1);
                    rec.pivot = Vector2(1,1);
                    rec.anchoredPosition = Vector2.zero;
                    rec.sizeDelta = Vector2(width,height);
                }
                return imagObj;
            }
        function createImage(x,y,width,height,color){

            if(shitao.canvObj == null){
                shitao.canvObj = GameObject();
                var canv = shitao.canvObj.gameObject.AddComponent(Canvas);
                canv.renderMode = RenderMode.ScreenSpaceOverlay;
                shitao.canvObj.layer = 5
            }
            //back image
            var imagObj = GameObject();
            imagObj.layer = 5;
            imagObj.gameObject.transform.parent = shitao.canvObj.transform;
            //image rendertexture
            var ima = imagObj.gameObject.AddComponent(Image);
            ima.color = color;
            //image pos width height
            var rec = ima.gameObject.GetComponent(RectTransform);
                rec.anchorMax = Vector2.zero;
                rec.anchorMin = Vector2.zero;
                rec.pivot = Vector2.zero;
                rec.anchoredPosition = Vector2.zero;
                rec.sizeDelta = Vector2(width,height);
            return imagObj;
        }


        renderTex:null
        function createRawImage(x,y,width,height){

            if(shitao.canvObj == null){
                shitao.canvObj = GameObject();
                var canv = shitao.canvObj.gameObject.AddComponent(Canvas);
                canv.renderMode = RenderMode.ScreenSpaceOverlay;
                shitao.canvObj.layer = 5;
            }
            var ui = GameObject();
            ui.layer = 5;
            ui.gameObject.transform.parent = shitao.canvObj.transform;
            //image rendertexture
            var ima = ui.gameObject.AddComponent(RawImage);
            if(shitao.renderTex != null){

                GameObject.Destroy(shitao.renderTex);
            }
            shitao.renderTex = RenderTexture(452,280,100);
            ima.texture = shitao.renderTex;
            //image pos width height
            var rec = ui.gameObject.GetComponent(RectTransform);
                rec.anchorMax = Vector2.zero;
                rec.anchorMin = Vector2.zero;
                rec.pivot = Vector2.zero;
                rec.anchoredPosition = Vector2.zero; //Vector2(0, Screen.height*0.5);
                rec.sizeDelta = Vector2(width,height);
            return ui;
        }
        topCamera:null
        function CreateTopCamera(size){

            if(shitao.topCamera != null)
            {
                GameObject.Destroy(shitao.topCamera.gameObject);
            }

            var a = GameObject();
            b = a.gameObject.AddComponent(Camera);
            b.orthographic = true; //相机正交
            b.orthographicSize = size;//正交大小

            b.clearFlags = CameraClearFlags.SolidColor;
            b.backgroundColor = Color (1, 1, 1, 1);

            camera.AddCameraLayer(b,26);//1L | (1L<<1)|(1L<<2) |(1L<<4)|(1L<<9)|(1L<<10)|(1L<<11)|(1L<<12)|(1L<<14)|(1L<<19)|(1L<<20) |(1L<<26)
            //camera targetTexture
            b.targetTexture = shitao.renderTex;

            return b;
        }



        boundImg:null;
        backImg:null;
        rawImg:null;
        arrowImg:null;//小地图右上角图标


        function initFrusm(){

            //back image bound
            shitao.boundImg = shitao.createImage(-300,200,228,142,Color (1, 1, 1, 1));//?????
            //back image
            shitao.backImg = shitao.createImage(-300,200,226,140,Color (0, 0.5, 0, 1));
            //image
            shitao.rawImg = shitao.createRawImage(-300,200,226,140);//小地图的宽高226,140
            // 根据贴图包创建界面
            function init_gui(texture) {
                var tex = texture;
                var sp =  Sprite.Create(tex,Rect(0,0,tex.width,tex.height),Vector2(0.5,0.5));
                shitao.arrowImg = shitao.createImageByType(tex.width,tex.height,sp,shitao.rawImg,"rightUp");
            }

            var url_arrow = bundleUrl+"assets/st/res_arrow.png"
            util.downloadTexture({
                "url": url_arrow,
                "success": init_gui
            });


            //camera
            shitao.topCamera = shitao.CreateTopCamera(1000);
            shitao.setTopCamera();
            // camera cullmask
            camera.RemoveCameraLayer(camera.cam,26);//1L |(1L<<1)|(1L<<2) |(1L<<4)|(1L<<9)|(1L<<10)|(1L<<11)|(1L<<12)|(1L<<14)|(1L<<19)|(1L<<20)


            //初始化时查询在准备第一人称行走时的射线检测的模式应该设置成什么
        shitao.queryCheckCollider();

        }

        function queryCheckCollider(){

            if(levelManager.CurBaseObj.ClsID == ObjectFactory.CLSID_WORLD)
                {
                    var part0 = GameObject.Find("dx_zhuti_MeshPart0");
                    if(part0 != null)
                    {
                        if(fpsPutState != null)
                            fpsPutState.checkCollider = true;
                        return;
                    }

                }
                if(fpsPutState != null)
                    fpsPutState.checkCollider = false;

        }


        function onFPSStart(){

            AutoRender.walking = true;
        }

        function onFPSEnd(){

            AutoRender.walking = false;
        }

        bd:null;
        multiple:0;
        function setTopCamera(){
            var obj = levelManager.CurBaseObj;
            var bound =  ObjectUtil.CalculateBounds (obj.gameObject);
            shitao.bd = bound;
            var x = bound.extents.x;
            var z = bound.extents.z;
            var max = Mathf.Max(x,z);

        shitao.multiple = 1.1;

            shitao.topCamera.orthographicSize = max *1.1;
            shitao.topCamera.farClipPlane = 1500;
            shitao.topCamera.transform.position = bound.center + Vector3(0,1000,0);
            shitao.topCamera.transform.rotation = Quaternion.Euler(90,0,0);
        }

        function setInspectorSize(){

            var obj = levelManager.CurBaseObj.gameObject;
            var bound = ObjectUtil.CalculateBounds (obj);

            var x = bound.extents.x;
            var y = bound.extents.y;
            var z = bound.extents.z;

            var max = Mathf.Max(x,z);
            var len = max *0.8;

            //shitao.cube.transform.localScale = Vector3(len,2,len);

        if(shitao.cube != null) {
            var scl = shitao.topCamera.orthographicSize;
            shitao.cube.transform.localScale = Vector3(scl, 1, scl);
        }
        }

    };

    AutoRender = {
        walking:false;
        function Start() {

            shitao.setInspectorSize();

            this.gameObject.layer = 26;

            var mf= this.gameObject.GetComponentsInChildren(Transform);
            for(var i = 0; i < mf.Length; i ++) {
                var child = (mf.GetValue (i));
                child.gameObject.layer = 26;
            }

            var mc = this.gameObject.GetComponentsInChildren(Collider);
            for(var i = 0; i < mc.Length; i ++) {
            var child = (mc.GetValue (i));
                child.enabled = false;
            }
        }

        function Update()
        {

            if(AutoRender.walking == false)
            {
                // var pointOnPlane = Vector3.ProjectOnPlane (camera.gameObject.transform.position, Vector3.up);
                // var pos = camera.gameObject.transform.position
                // pos.y = Mathf.Clamp(pos.y,20,2000);
                // this.transform.position = pos;

                var vec = camera.target.position - camera.gameObject.transform.position;
                var vecOnPlane = Vector3.ProjectOnPlane (vec, Vector3.up);
                var tPoint = this.transform.position + vecOnPlane;
                this.gameObject.transform.LookAt(tPoint);

                shitao.cube.transform.position = camera.gameObject.transform.position;

            }
            else
            {
                var person = GameObject.FindGameObjectWithTag ("MainCamera");
                if(person)
                {
                    var pos = person.gameObject.transform.position;
                    pos.y = Mathf.Clamp(pos.y,20,2000)
                    shitao.cube.transform.position = pos;

                    var angle = person.transform.eulerAngles;
                    shitao.cube.transform.rotation = Quaternion.Euler(angle);//person.transform.rotation;//

                }
            }

        }
    }

    var enableDrag = false;
    var drag = false;
    var downPos = null;
    var currentPos = null;
    var currentScale = Vector2.one;

    var sizeDelta = Vector2.one;
    var enableCamera = true;
    var windowWidth = Screen.width;
    var windowHeight = Screen.height;

    //添加鼠标监听事件
    function addListenerMouse(){
        var downX = 0;
        var downY = 0;
        var downZ = 0;
        var cameraX = 0 ;
        var cameraY = 0;
        var cameraZ = 0;
        util.addEventListener("mousedown",function(event){
            downPos = Vector2(event.x,Screen.height- event.y);
            if(event.button != 0)//不是鼠标点击返回
                return;
            if(RectTransformUtility.RectangleContainsScreenPoint(shitao.arrowImg.gameObject.GetComponent(RectTransform),downPos)){
                currentScale = shitao.rawImg.transform.localScale;
                enableDrag = true;
            }
            if(RectTransformUtility.RectangleContainsScreenPoint(shitao.rawImg.gameObject.GetComponent(RectTransform),downPos)){
                currentScale = shitao.rawImg.transform.localScale;
                drag = true;
                if(RectTransformUtility.RectangleContainsScreenPoint(shitao.arrowImg.gameObject.GetComponent(RectTransform),downPos)){
                    drag = false;
                }
                downX = event.x;
                downY = event.y;
                downZ = event.z;
                cameraX = shitao.topCamera.transform.position.x ;
                cameraY = shitao.topCamera.transform.position.y ;
                cameraZ = shitao.topCamera.transform.position.z ;
                enableCamera = false;
            }

        })

        util.addEventListener("mouseup",function(event){

            if(event.button != 0)
                return;

            if(enableDrag == true){
                var newRender = RenderTexture(sizeDelta.x,sizeDelta.y,100);
            var oldRenderTex = shitao.renderTex;

            shitao.renderTex = newRender;
            shitao.topCamera.targetTexture = newRender;
            shitao.rawImg.gameObject.GetComponent(RawImage).texture = newRender;

                oldRenderTex.Release();
                GameObject.Destroy(oldRenderTex);

            }else if(drag == true){
                drag = false;
            }
            enableDrag = false;
            enableCamera = true;
        })
        util.addEventListener("mousemove",function(event){

            currentPos = Vector2(event.x,Screen.height- event.y);
            if(enableDrag == true){
                var vec = currentPos - downPos;
                var dis = Mathf.Abs(vec.y) > Mathf.Abs(vec.x) ? vec.y : vec.x;
                sizeDelta = shitao.boundImg.GetComponent(RectTransform).sizeDelta;
                sizeDelta = sizeDelta + Vector2(1,sizeDelta.y/sizeDelta.x) *dis;
                sizeDelta = Vector2(Mathf.Clamp(sizeDelta.x,113,678),Mathf.Clamp(sizeDelta.y,70,420)){
                    shitao.boundImg.GetComponent(RectTransform).sizeDelta = sizeDelta;
                    shitao.backImg.GetComponent(RectTransform).sizeDelta = sizeDelta;
                    shitao.rawImg.GetComponent(RectTransform).sizeDelta = sizeDelta;
                }
            }else if(drag == true){
                var viewSizeDelta = shitao.rawImg.GetComponent(RectTransform).sizeDelta;
                var pos1 = Vector3(downX/viewSizeDelta.x ,(Screen.height - downY)/viewSizeDelta.y,0);
                var pos2 =  Vector3(event.x/viewSizeDelta.x,(Screen.height-event.y)/viewSizeDelta.y,0);

                pos1 = shitao.topCamera.ViewportToWorldPoint(pos1);
                pos2 = shitao.topCamera.ViewportToWorldPoint(pos2);
                var deltaPos = pos1-pos2;

                shitao.topCamera.transform.position = Vector3(cameraX, cameraY, cameraZ) + Vector3(deltaPos.x, 0,deltaPos.z);

            }
            downPos = currentPos;
        })


        util.setRenderCallback(function(){
            if(RectTransformUtility.RectangleContainsScreenPoint(shitao.rawImg.gameObject.GetComponent(RectTransform),currentPos)){
            camera.enableZoom = false;
                camera.enableRot = false;
                camera.enablePan = false;
            }else{
                if(enableCamera){
            camera.enableZoom = true;
                    camera.enablePan = true;
            if(!camera.IsOrtho())
            camera.enableRot = true;
                }
            }
        //窗口变化是，保证小地图的窗口不发生变化
            if(Screen.width != windowWidth || Screen.height != windowHeight){
                sizeDelta = shitao.boundImg.GetComponent(RectTransform).sizeDelta;
                sizeDelta = Vector2(Mathf.Clamp(sizeDelta.x,113,678),Mathf.Clamp(sizeDelta.y,70,420)){
                    shitao.boundImg.GetComponent(RectTransform).sizeDelta = sizeDelta;
                    shitao.backImg.GetComponent(RectTransform).sizeDelta = sizeDelta;
                    shitao.rawImg.GetComponent(RectTransform).sizeDelta = sizeDelta;
                }
                var newRender = RenderTexture(sizeDelta.x,sizeDelta.y,100);

                shitao.renderTex.Release();
                GameObject.Destroy(shitao.renderTex);

                shitao.rawImg.gameObject.GetComponent(RawImage).texture = newRender;

                shitao.renderTex = newRender;
                shitao.topCamera.targetTexture = newRender;
                windowWidth = Screen.width;
                windowHeight = Screen.height;
            }
        })

        util.addEventListener("mousewheel",function(event){
            currentPos = Vector2(event.x,Screen.height- event.y);
            if(RectTransformUtility.RectangleContainsScreenPoint(shitao.rawImg.gameObject.GetComponent(RectTransform),currentPos)){
                var x = shitao.bd.extents.x;
                var z = shitao.bd.extents.z;
                var max = Mathf.Max(x,z);

                if(event.z > 0){//向上滚
                    shitao.multiple = shitao.multiple - 0.01;
                }else if(event.z < 0){//向下滚
                    shitao.multiple = shitao.multiple + 0.01;
                }
            if(shitao.multiple <= 0.0001)
            shitao.multiple = 0.0001;
            else if(shitao.multiple > 10000)
            shitao.multiple = 10000;

                shitao.topCamera.orthographicSize = max *shitao.multiple;

            if(shitao.cube != null) {
            var scl = shitao.topCamera.orthographicSize;
            shitao.cube.transform.localScale = Vector3(scl, 1, scl);
            }
            }
        });

    }
    //监听楼体变化
    util.addEventListener("levelchange",function(obj) {//进入建筑层级
        if(miniMap.isOpen)
        {
            shitao.queryCheckCollider();
            shitao.setTopCamera();
            shitao.setInspectorSize();
        }

    })
    //关闭鹰眼图
    function destroyMinimap(){
        if(shitao.cube != null){
            GameObject.Destroy(shitao.cube.gameObject);
        }
        if(shitao.boundImg != null){
            GameObject.Destroy(shitao.boundImg.gameObject);
        }
        if(shitao.backImg != null){
            GameObject.Destroy(shitao.backImg.gameObject);
        }
        if(shitao.rawImg != null){
            GameObject.Destroy(shitao.rawImg);
        }

        if(shitao.topCamera!= null){
            GameObject.Destroy(shitao.topCamera.gameObject);
        }
        if(shitao.canvObj != null){
            GameObject.Destroy(shitao.canvObj.gameObject);
        }
    }

    miniMap = {
        isOpen = false;
    };
    eagleEyeOPen.miniMap.open = function() {
        shitao.initFrusm();
        addListenerMouse();
        shitao.CreateInspector();
        if(fpsCtrlState != null) {
            fpsCtrlState.OnStart += shitao.onFPSStart;
            fpsCtrlState.OnEnd += shitao.onFPSEnd;
        }
        miniMap.isOpen = true;
    }
    eagleEyeOPen.miniMap.close = function () {
        util.setRenderCallback(null);
        util.clearAllEvents();
        destroyMinimap();

        if(fpsCtrlState != null) {
        fpsCtrlState.OnStart -= shitao.onFPSStart;
        fpsCtrlState.OnEnd -= shitao.onFPSEnd;
        }
        miniMap.isOpen = false;
    }
    return miniMap
}

eagleEyeOPen.miniMap();


// 当前层级缓存
CurrentLevel = {
	obj:null,
	showAnaly: false,
	build: null,
	buildBs: false,
	aroundState: true,
	aroundIn_build: true,
}
/**
 * 对js发布接口
 * @author yf_d
 * @author haaid
 * @date 2017-10-23 14:42:28
 */
jsi = {
	/**
	 * 创建物体
	 */
	function create(obj, func) {
		_curd.c(json.decode(obj), function(data) {
			CallJS(true, { funcid: func, data: data });
		});
	}
	/**
	 * 删除物体
	 */
	function destroy(sel, func) {
		_curd.d(sel, function(data) {
			CallJS(true, { funcid: func, data: data });
		});
	}
	/**
	 * 获取物体
	 */
	function get(id, func) {
		var obj = _Q(id)[0];
		if (obj) {
			CallJS(true, {funcid: func, data: ParseJson(obj)});
		} else {
			CallJS(true, {});
		}
	}
	/**
	 * 查询物体
	 * @author haaid
	 * @see {@link https://www.kancloud.cn/looklook1/api/440940 | 模模搭API}
	 */
	function query(sel, cat, func) {
		var objList = _Q(json.decode(sel), cat);

		foreach (var item in pairs(objList)) {
			objList[item.key] = ParseJson(item.value);
		}

		CallJS(true, {funcid: func, data: objList});
	}
	/**
	 * 属性挂载
	 * @desc 将一些属性在初始化的时候挂载在实例上
	 */
	function mount(method, func) {
		_mount.bind(method, function(event) {
			CallJS(true, {funcid: func, data: event});
		})
	}
	/**
	 * 事件绑定
	 */
	function on(events, id, func) {
		if(func){
			_event.bind(events, _Q(id), function(event) {
				CallJS(true, {funcid: func, data: event});
			});
		} else {
			func = id;
			_event.bind(events, function(event) {
				CallJS(true, {funcid: func, data: event});
			});
		}
	}
	function off(events, id) {
		if(id){
			_event.unbind(events, _Q(id));
		} else {
			_event.unbind(events);
		}
	}
	/**
	 * 属性设置
	 */
	function attr(id, key, value) {
		var thing = _Q(id)[0];
		if (thing) {
			thing.addProperty(key, value);
			if(key == "uiKey"){
				selector.ClearSelection();
				var objs =  object.findByProperty("uiKey");
				for (var j = 0; j < objs.Count; j ++){
					var obj = objs.get_Item(j);
					var uiKey = obj.getProperty("uiKey");
					if(uiKey == 'false') {
						obj.PickEnabled = false;
					} else {
						obj.PickEnabled = true;
					}
				}
			}
		}
	}
	/**
	 * 闪烁
	 */
	function flash(id, clr, time) {
		var thing = _Q(id)[0];
		var data = json.decode(clr);
		if (thing) {
			if (clr == false) {
				thing.setColorFlash(false);
			}else {
				thing.setColorFlash(true, Color(data[0], data[1], data[2]), time);
			}
		}
	}
	/**
	 * 显示隐藏
	 */
	function show(id, bool) {
		var thing = _Q(id)[0];
		if (thing) {
			thing.Show(bool);
		}
	}
	/**
	 * 获取当前层级的位置信息
	 */
	function getlevel(func){
		var cur = levelManager.CurBaseObj;
		CallJS(true, {funcid: func, data: {id:cur.ID, name:cur.Name,type:cur.Cls}});
	}
	/**
	 * 建筑操作
	 * @author haaid
	 * @date 2017-10-27 13:56:16
	 */
	build = {
		/**
		 * 样式设置
		 */
		style = {
			function opacity(id, value) {
				foreach(var bd in pairs(world.buildingList)) {
					if (!bd || bd.ID != id) continue;
					// 外立面（向下取整，非1的值都隐藏）
					jsi.build.facade(bd, Math.Floor(value));
					// 楼层
					for(var i = 0; i < bd.planList.Count; i++) {
						var plan = bd.planList.get_Item(i);
						if (value == 1) {
							plan.resetTransparent();
						}else {
							plan.setTransparent(value)
						}
					}
				}
			}
		}
		/**
		 * 外立面操作
		 */
		function facade(bd, bool) {
			for(var i = 0; i < bd.facadeList.Count; i++) {
				var facade = bd.facadeList.get_Item(i);
				facade.Show(bool);
			}
		}
	}
	/**
	 * 物体操作
	 * @author haaid
	 * @date 2017-10-23 14:46:13
	 */
	thing = {
		/**
		 * move 动画设置
		 */
		function move(id, value) {
			var thing = _Q(id)[0];
			var data = json.decode(value);
			if (thing) {
				thing.moveTo(U.CT(data.pos), data.time);
			}
		}
		/**
		 * 删除
		 * @param {*} selector 
		 * @param {*} func 
		 */
		function destroy(sel) {
			_curd.d(sel, function(){});
		}

		/**
		 * 打开视域
		 * @param {*} bool 
		 * @param {*} id 
		 */
		function openVideo(bool, id) {
			// 判断是否是摄像头
			var obj = _Q(id)[0];
			if(obj.getProperty('物体类型') == '摄像头'){
				obj.open(true);
			}
			return
		}

		/**
		 * 样式设置
		 */
		style = {
			function rotate(id, value) {
				var thing = _Q(id)[0];
				var data =  json.decode(value);
				if (thing) {
					thing.pitch(data[0]);
					thing.yaw(data[1]);
					thing.roll(data[2]);
				}
			}
			function color(id, value) {
				var thing = _Q(id)[0];
				var data = json.decode(value);
				if (thing) {
					thing.setColor(Color(data[0], data[1], data[2]));
				}
			}
			function scale(id, value) {
				var thing = _Q(id)[0];
				var data = json.decode(value);
				if (thing) {
					thing.setScale(data[0], data[1], data[2]);
				}
			}
			function opacity(id, value) {
				var thing = _Q(id)[0];
				if (thing) {
					thing.setTransparent(value);
				}
			}
			function position(id, value) {
				var thing = _Q(id)[0];
				var data = json.decode(value);
				if (thing) {
					thing.setPosition(Vector3(data[0], data[1], data[2]));
				}
			}
			function translate(id, value) {
				var thing = _Q(id)[0];
				var data = json.decode(value);
				if(thing){
					thing.translate(U.CT(data));
				}
			}
		}
		
	}
	/**
	 * 线条操作
	 */
	line = {
		/**
		 * 添加点
		 */
		function addPoint(id, value) {
			var thing = _Q(id)[0];
			var data = json.decode(value);
			if (thing) {
				thing.addPoint(U.CT(data.pos));
				thing.build();
			}
		}
		/**
		 * 添加多个点
		 */
		function addPoints(id, value) {
			var thing = _Q(id)[0];
			var data = json.decode(value);
			if (thing) {
				var points = data.pos;
				foreach(var pos in vpairs(points)){
					thing.addPoint(U.CT(pos));
				}
				thing.build();
			}
		}
		/**
		 * 样式设置
		 */
		style = {
			function color(id, value) {
				var thing = _Q(id)[0];
				var data = json.decode(value);
				if (thing) {
					thing.setColor(Color(data[0], data[1], data[2]));
					thing.build();
				}
			}
		}
	}

	/**
	 * 气泡操作
	 */
	bubble = {
		/**
		 * 设置气泡属性
		 */
		function setBubble(id, val) {
			var data = json.decode(val);
			var ui = _map.bubble[id];
			if (ui) {
				// 设置气泡缩放
				var scale = data.scale;
				if (type(scale) == 5) {
					ui.setScale(scale[0], scale[1]);
				}
				// 设置气泡文字
				var text = data.text;
				if (text) {
					text = string.replace(text, '<br>', '\\n');
					text = string.replace(text, '<br/>', '\\n');
					text = string.replace(text, '<br />', '\\n');
					ui.setText('Button/Text', text);
				}
				// 设置气泡文字大小
				var textSize = data.textSize;
				if (textSize) {
					var textUI = ui.findText('Button/Text');
					textUI.fontSize = toint(textSize);
				}
				// 设置气泡文字颜色
				var textColor = data.textColor;
				if (type(textColor) == 5) {
					ui.setTextColor('Button/Text', Color(textColor[0], textColor[1], textColor[2]));
				}
				// ui.show(false);
			}
		}
		/**
		 * 气泡绑定事件
		 * @param {*} id 
		 * @param {*} fuc 
		 */
		function on(id, fuc) {
			var ui = _map.bubble[id];
			if(ui){
				ui.regButtonEvent("Button", function() {
					var data = {
						"type": "Bubble",
						"depend": ParseJson(_Q(id)[0]),
						"event":"click"
					};
					CallJS(true, {funcid: fuc, data: data});
				});
			}
		}
		/**
		 * 改变图片
		 */
		function changeImage(id, url){
			var ids = [];
			if(id && url) {
				if(type(id) == 5){
					ids = id;
				}else{
					ids[0] = id;
				}
				util.downloadTexture({
					"url": url,
					"success":function(tex) {
						var ui;
						for(var i = 0; i < ids.length;i++) {
							ui = _map.bubble[ids[i]];
							if(ui){
								ui.setImage("Button",tex);								
							}
						}
					}
				});
			}
		}
		/**
		 * 设置显示隐藏
		 */
		function show(id) {
			var ids = [];
			// var boo = json.decode(bool);
			if(id){
				if(type(id) == 5){
					ids = id;
				}else{
					ids[0] = id;
				}
				var ui;
				// var objs = _Q([{'物体类型': type}], 'props');
				// for(var i = 0; i < ids.length;i++){
				// 	ui = _map.bubble[ids[i]];
				// 	// 判断当前层级，进行当前层级的显示
				// 	if(ui){
				// 		ui.show(true);						
				// 	}
				// }
				for(var i = 0; i < ids.length; i++) {
					var item = _Q(ids[i]);
					if(array.count(item) == 0) {
						return;
					}
					ui = _map.bubble[ids[i]];
					if(CurrentLevel.obj == null || CurrentLevel.obj.ClsID == ObjectFactory.CLSID_WORLD) {
						if(item[0].uid == ""){
							continue;
						}
						if(item[0].ParentObject.ParentObject.ClsID == ObjectFactory.CLSID_WORLD){
							ui.show(true);
						}else {
							ui.show(false);
						}
					}else if(CurrentLevel.obj.ClsID == ObjectFactory.CLSID_BUILDING){
						_clearAllUi();
						return;
					}else{
						if(item[0].uid == ""){
							continue;
						}
						if(item[0].ParentObject == CurrentLevel.obj) {
							ui.show(true);
						}else {
							ui.show(false);
						}
					}
				}
			}		
		}
		function hide(id) {
			var ids = [];
			if(id){
				if(type(id) == 5){
					ids = id;
				}else{
					ids[0] = id;
				}
				var ui;
				for(var i = 0; i < ids.length;i++){
					ui = _map.bubble[ids[i]];
					if(ui){
						ui.show(false);						
					}
				}
			}		
		}
		/**
		 * 删除气泡
		 */
		function deleteBubble(id){
			if(id){
				var ids = [];
				if(type(id) == 5){
					ids = id;
				}else{
					ids[0] = id;
				}
				var ui;
				for(var i = 0; i < ids.length;i++){
					ui = _map.bubble[ids[i]];
					if(ui){
						ui.destroy();					
					}
				}
			}
		}
	}
	/**
	 * 面板操作
	 * @author haaid <me@wanghaida.com>
	 * @date 2018-4-19 13:40:33
	 * @desc 对场景内默认面板进行操作
	 */
	panel = {
		show: function (panel, bool) {
			gui.showPanel(panel, bool);
		},
		load: function (param) {
			gui.load(param.url, function (ugui) {
				foreach(var item in pairs(param.click)) {
					ugui.regToggleEvent(item.key, function (isOn) {
						CallJS(true, {funcid: item.value, data: isOn});
					});
				}
			});
		}
	}
	/**
	 * camera 操作
	 */
	cam = {
		// 相机飞行
		function flyTo(id, time, fuc) {
			var data = json.decode(id);
			var eye,target;
			if(id && type(data) == 5){
				eye = U.CT(data);
				target = eye;
			}else{
				if(_Q(data)){
					var obj = _Q(data)[0];
					eye = obj.pos + Vector3(obj.size.x, obj.size.y, -obj.size.z*3);
					target = obj.center;
				}
			}	
			camera.flyTo({
				"eye": eye,
				"target":  target,
				"time": time,
				"complete":function(){
					jsi.mount("cam",fuc);
				}
			}) 
		}
		// 摄像机聚焦在给定物体上
		function fit (id) {
			var data = json.decode(id);
			var obj = _Q(data)[0];
			if(obj) {
				// 默认状态下摄影机只飞行一次，level.change也有一次要飞行，所以下一就不在飞了。关闭change飞行
				levelManager.EnableFlyCamera = false;
				if(obj.ParentObject.ParentObject.ClsID == ObjectFactory.CLSID_WORLD){
					level.change(obj.ParentObject.ParentObject);
				}else{
					level.change(obj.ParentObject);
				}
				levelManager.EnableFlyCamera = true;
				camera.FitBestView(obj.gameObject, Vector3(2, 2, 2));
				camera.PunchDistance(5);
			}
		}
		// 相机的注视点
		function lookAt (id) {
			var data = json.decode(id);
			var obj = _Q(data)[0];
			if(obj) {
				camera.lookAt(obj.center); 
			}
		}
		// 相机的位置
		function setposition (pos) {
			var data = json.decode(pos);
			var obj = U.CT(data);
			if(obj) {
				camera.setPosition(obj); 
			}
		}
		// 切换2d/3d 场景
		function transferView(){
			if(camera.IsOrtho()){
				camera.changeTo3D();
			}else{
				camera.changeTo2D();
			}
			
		}
	}
	/**
	 * 鹰眼显示与隐藏
	 */
	eagleShow = {
		function openMini() {
			print('进来了111');
			eagleEyeOPen.miniMap.open()
		}
		function closeMini() {
			print('miniClose');
			eagleEyeOPen.miniMap.close()
		}
	}
};/**
 * 属性挂载
 * @desc 将一些属性在初始化的时候挂载在实例上
 */
var mountArr  = ['buildings', 'cam'];
var mountData = [];

foreach(var i in pairs(mountArr)) {
    _mount.bind(i.value, function (event) {
        array.add(mountData, event);
    });
}
/**
 * 加载完主脚本后执行的方法
 * 可以把场景数据推送到js端
 */
CallJS(true, {funcid: 'ready', data: mountData});`);
};
!function(t,e){for(var n in e)t[n]=e[n]}(window,function(t){function e(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=6)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o={id:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;return Number(Math.random().toString().substr(3,t)+Date.now()).toString(36)},color:function(t){"#"===t.charAt()&&(t=t.substr(1)),(t=t.split("")).forEach(function(t,e,n){n[e]=parseInt(t,16)});var e=0,n=0,o=0;return 3===t.length&&(e=16*t[0]+t[0],n=16*t[1]+t[1],o=16*t[2]+t[2]),6===t.length&&(e=16*t[0]+t[1],n=16*t[2]+t[3],o=16*t[4]+t[5]),[+(e/255).toFixed(2),+(n/255).toFixed(2),+(o/255).toFixed(2)]},toJson:function(t){return JSON.stringify(t)},toObj:function(t){return JSON.parse(t)},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},isObject:function(t){return"[object Object]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"===Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"===Object.prototype.toString.call(t)},isFunction:function(t){return"[object Function]"===Object.prototype.toString.call(t)},emptyObj:function(t){return"{}"==JSON.stringify(t)},emptyArray:function(t){return"[]"==JSON.stringify(t)},log:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"debug";"log"===e?console.log(t):"info"===e?console.info(t):"warn"===e?console.warn(t):"error"===e?console.error(t):console.debug(t)}};e.U=o},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Ddd=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),a=n(0),c=n(7),u=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(o(this,t),"object"===r(t.instance))return t.instance;this.version="3.0.0.180119",t.version=this.version,t.decorate=new c.Decorate(this),this.opt={el:"#unityPlayer",logo:"img/loading_logo.png",mode:"Preview",scene:"",debug:!1},Object.assign(this.opt,e);var n=this.opt.mode,i=this.opt.config||{belong:1,modelBelong:1};"Create"===n?this.u3d=Pen(i).draw():"Edit"===n?this.u3d=Pen(i).draw(this.opt.scene):"Preview"===n?this.u3d=Pen(i).browse(this.opt.scene):a.U.log("场景模式错误！(DddJS)","error"),t._app=this;var u=t.prototype;return u.state="Preview"!=n,u.version=this.version,u.screen={resize:function(e,n){t._app.u3d.resize(e,n)},setWidth:function(e){t._app.u3d.setWidth(e)},setHeight:function(e){t._app.u3d.setHeight(e)}},t.instance=u,t.instance}return i(t,[{key:"ready",value:function(e){"function"==typeof e&&t.ready.push(e)}},{key:"handleComplete",value:function(e){"function"==typeof e&&(t.onComplete=e)}},{key:"log",value:function(t){uModel.LoadScriptString("console.show("+t+")")}}],[{key:"then",value:function(e){return"ready"===(e=JSON.parse(e)).data.funcid?(this.decorate.till(e.data.data),void t.ready.forEach(function(e){e(t.instance)})):"complete"===e.data.funcid?t.onComplete(this.decorate.till(e.data.data)):"console"===e.data.funcid?a.U.log(e.data.data.msg,e.data.data.lv):void(this.cach[e.data.funcid]&&this.cach[e.data.funcid](this.decorate.till(e.data.data)))}},{key:"run",value:function(e,n){var o="";"function"==typeof n&&(o=Object.keys(t.cach).length,t.cach[o]=n,e=e.replace("_callback_",o)),t._app.opt.debug&&a.U.log("run: "+e,"info"),uModel.LoadScriptString(e)}},{key:"extend",value:function(){var t=void 0,e=void 0,n=void 0,o=arguments[0]||{},i=1,a=arguments.length;for("boolean"==typeof o&&(o,o=arguments[i]||{},i++),"object"===(void 0===o?"undefined":r(o))||jQuery.isFunction(o)||(o={}),i===a&&(o=this.prototype,i--);i<a;i++)if(null!=(t=arguments[i]))for(e in t)o[e],n=t[e],o[e]=n}}]),t}();u.cach={},u.ready=[],u.onComplete=function(){},e.Ddd=u},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Base=void 0;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();n(0),n(1),e.Base=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,t),this.app=e,this.node=n,this.type=n.type}return r(t,[{key:"toString",value:function(){for(var t=Object.getOwnPropertyNames(this),e="{",n=0;n<t.length;n++){var o=t[n],r=this[o];if("_style"==o)for(var i=Object.getOwnPropertyNames(r),a=0;a<i.length;a++)e+=(e.endsWith(",")?"":",")+i[a]+":"+r[i[a]];else if("_attr"==o){e+=",props:{";for(var c=Object.getOwnPropertyNames(r),u=0;u<c.length;u++)e+=(0==u?"":",")+c[u]+":"+r[c[u]];e+="}"}else e+=(e.endsWith("{")?"":",")+o+":"+r}return e+="}"}}]),t}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Line=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),c=n(0),u=n(5),s=n(17);e.Line=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i._style=new s.LineStyle(i.id,n),i}return i(e,u.Placement),a(e,[{key:"addPoint",value:function(t){var e={pos:t},n="jsi.line.addPoint('"+this.id+"', '"+c.U.toJson(e)+"')";Ddd.run(n)}},{key:"addPoints",value:function(t){var e={pos:t},n="jsi.line.addPoints('"+this.id+"', '"+c.U.toJson(e)+"')";Ddd.run(n)}}]),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Attr=void 0;n(0);var r=n(1);e.Attr=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,t),this.id=e;var i=this;return new Proxy(n,{set:function(t,e,n){t[e]=n;var o="jsi.attr('"+i.id+"', '"+e+"', '"+n+"')";return r.Ddd.run(o),!0},get:function(t,e){if(e in t)return t[e];throw new ReferenceError('Property "'+e+'" does not exist.(DddJS)')}})}},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Placement=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),u=n(0),s=n(1),l=n(2),f=n(4);e.Placement=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.id=n.id,i.pid=n.parentId,i.name=n.name,i._attr=new f.Attr(i.id,n.props),i}return i(e,l.Base),c(e,[{key:"on",value:function(t,e,n){if(!t)return u.U.log("必须声明待绑定的事件类型！","error");"function"==typeof e&&(n=e,e=void 0);var o="jsi.on('"+t+"', '"+this.id+"', _callback_)";s.Ddd.run(o,n)}},{key:"off",value:function(t){if(!t)return u.U.log("必须声明待解绑的事件类型！","error");var e="jsi.off('"+t+"', '"+this.id+"')";s.Ddd.run(e)}},{key:"click",value:function(t,e){this.on("click",t,e)}},{key:"dbclick",value:function(t,e){this.on("dbclick",t,e)}},{key:"attr",value:function(t,e){if(void 0===t)return this._attr;if(t&&"object"===(void 0===t?"undefined":a(t)))for(var n in t)this._attr[n]=t[n];else{if(void 0===e)return this._attr[t];void 0!==e&&(this._attr[t]=e)}}},{key:"style",value:function(t,e){if(void 0===t)return this._style;if(t&&"object"===(void 0===t?"undefined":a(t)))for(var n in t)this._style[n]=t[n];else{if(void 0===e)return this._style[t];void 0!==e&&(this._style[t]=e)}}},{key:"flash",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n="";n="boolean"==typeof t?"jsi.flash('"+this.id+"', false)":"jsi.flash('"+this.id+"', '"+u.U.toJson(u.U.color(t))+"', "+e+")",s.Ddd.run(n)}},{key:"show",value:function(t){var e="jsi.show('"+this.id+"', "+t+")";s.Ddd.run(e)}},{key:"move",value:function(t){var e={pos:t,time:arguments.length>1&&void 0!==arguments[1]?arguments[1]:1},n="jsi.thing.move('"+this.id+"', '"+u.U.toJson(e)+"')";s.Ddd.run(n)}},{key:"destroy",value:function(){var t=[this.id],e="jsi.thing.destroy('"+u.U.toJson(t)+"')";s.Ddd.run(e)}},{key:"createBubble",value:function(t,e){!e&&t.hasOwnProperty("complete")&&u.U.isFunction(t.complete)&&(e=t.complete),t.type="Bubble",t.depend=this.id,t.style&&(t.style.color&&(t.style.color=u.U.color(t.style.color)),t.style.arrowColor&&(t.style.arrowColor=u.U.color(t.style.arrowColor)),t.style.textColor&&(t.style.textColor=u.U.color(t.style.textColor)));var n="jsi.create('"+u.U.toJson(t)+"', _callback_)";s.Ddd.run(n,e)}},{key:"showBubble",value:function(t){var e="jsi.bubble.show('"+this.id+"','"+t+"')";s.Ddd.run(e)}},{key:"deleteBubble",value:function(){var t="jsi.bubble.deleteBubble('"+this.id+"')";s.Ddd.run(t)}},{key:"open",value:function(t){var e="jsi.thing.openVideo('"+t+"', '"+this.id+"')";s.Ddd.run(e)}}]),e}()},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Ddd=void 0;var o=n(1);n(20),e.Ddd=o.Ddd},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Decorate=void 0;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),i=n(0),a=n(8),c=n(9),u=n(10),s=n(11),l=n(12),f=n(15),d=n(3),p=n(18),y=n(19);e.Decorate=function(){function t(e){o(this,t),this.app=e,this.farm={Event:a.E,Bubble:c.Bubble,Camera:u.Camera,Floor:l.Floor,Placement:f.Thing,CurveLine:d.Line,ArrowLine:y.ArrowLine,PipeLine:p.PipeLine,LongCurveLine:d.Line,MeshLine:d.Line,LongLine:d.Line,VideoProbe:f.Thing,FloorPlan:s.Level,Building:s.Level,World:s.Level}}return r(t,[{key:"till",value:function(t){if(Ddd._app.opt.debug&&i.U.log("till: "+JSON.stringify(t),"info"),i.U.isArray(t)){var e=this;return t.forEach(function(t,n,o){t&&t.type&&e.farm[t.type]&&(o[n]=new e.farm[t.type](e.app,t))}),t}return t&&t.type&&this.farm[t.type]?new this.farm[t.type](this.app,t):t}}]),t}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.E=void 0;n(0);var a=n(1),c=n(2);e.E=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.pos=n.pos,i.button=n.button,n.target&&(i.target=a.Ddd.decorate.till(n.target)),i}return i(e,c.Base),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Bubble=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),c=n(0),u=n(1),s=n(2);e.Bubble=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.id=n.depend.id,i.depend=u.Ddd.decorate.till(n.depend),i}return i(e,s.Base),a(e,[{key:"on",value:function(t,e,n){if(!t)return c.U.log("必须声明待绑定的事件类型！","error");"function"==typeof e&&(n=e,e=void 0);var o="jsi.bubble.on('"+this.id+"', _callback_)";u.Ddd.run(o,n)}},{key:"setBubble",value:function(t,e){var n={};!e&&c.U.isObject(t)?n=t:n[t]=e,t.textColor&&(n.textColor=c.U.color(n.textColor));var o="jsi.bubble.setBubble('"+this.id+"', '"+c.U.toJson(n)+"')";u.Ddd.run(o)}},{key:"changeImage",value:function(t){var e="jsi.bubble.changeImage('"+this.id+"','"+t+"')";u.Ddd.run(e)}},{key:"show",value:function(){var t="jsi.bubble.show('"+this.id+"')";u.Ddd.run(t)}},{key:"hide",value:function(){var t="jsi.bubble.hide('"+this.id+"')";u.Ddd.run(t)}},{key:"destroy",value:function(t){var e="jsi.bubble.deleteBubble('"+this.id+"')";u.Ddd.run(e)}}]),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Camera=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),c=n(0),u=n(1),s=n(2);e.Camera=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.camera=n.camera,i.target=n.camera.target,i.self=n.camera.self,i.camera.flyTo=i.flyTo,i.camera.fit=i.fit,i.camera.transferView=i.transferView,u.Ddd.instance.camera=i.camera,i}return i(e,s.Base),a(e,[{key:"flyTo",value:function(t,e){void 0==e&&(e=1);var n="jsi.cam.flyTo('"+c.U.toJson(t)+"','"+e+"', _callback_)";u.Ddd.run(n,function(){})}},{key:"fit",value:function(t){var e="jsi.cam.fit('"+c.U.toJson(t)+"')";u.Ddd.run(e)}},{key:"lookAt",value:function(t){var e="jsi.cam.lookAt('"+c.U.toJson(t)+"')";u.Ddd.run(e)}},{key:"position",value:function(t){var e="jsi.cam.setposition('"+c.U.toJson(t)+"')";u.Ddd.run(e)}},{key:"transferView",value:function(){u.Ddd.run("jsi.cam.transferView()")}}]),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Level=void 0;var a=n(2);e.Level=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.id=n.id,i.name=n.name,i}return i(e,a.Base),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Floor=void 0;n(0);var a=n(13);e.Floor=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return o(this,e),r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return i(e,a.Building),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Building=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=(n(0),n(1)),u=n(2),s=n(4),l=n(14);e.Building=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.build=n.buildings,i.build.forEach(function(t,e,n){t._attr=new s.Attr(t.id,t.props),t._style=new l.BuildStyle(t.id,t),t.attr=function(t,e){if(void 0===t)return this._attr;if(t&&"object"===(void 0===t?"undefined":a(t)))for(var n in t)this._attr[n]=t[n];else{if(void 0===e)return this._attr[t];void 0!==e&&(this._attr[t]=e)}},t.style=function(t,e){if(void 0===t)return this._style;if(t&&"object"===(void 0===t?"undefined":a(t)))for(var n in t)this._style[n]=t[n];else{if(void 0===e)return this._style[t];void 0!==e&&(this._style[t]=e)}}}),c.Ddd.instance.buildings=i.build,i}return i(e,u.Base),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.BuildStyle=void 0;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),i=(n(0),n(1));e.BuildStyle=function(){function t(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];o(this,t),this.id=e,this._opacity=1;var n=this,r={};return Object.defineProperties(r,{opacity:{set:function(t){n.setOpacity(t)},get:function(){return n._opacity}}}),r}return r(t,[{key:"setOpacity",value:function(t){if(this._opacity!=t){this._opacity=t;var e="jsi.build.style.opacity('"+this.id+"', "+this._opacity+")";i.Ddd.run(e)}}}]),t}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.Thing=void 0;n(0);var a=n(5),c=n(16);e.Thing=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i._style=new c.ThingStyle(i.id,n),i}return i(e,a.Placement),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.ThingStyle=void 0;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),i=n(0),a=n(1);e.ThingStyle=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,t),this.id=e,this._color=n.color,this._scale=n.scale,this._rotate=n.rotate,this._opacity=1,this._position=n.pos,this._translate=n.trans;var r=this,i={};return Object.defineProperties(i,{rotate:{set:function(t){r.setRotate(t)},get:function(){return r._rotate}},rotateX:{set:function(t){r.setRotate([t,0,0])},get:function(){return r._rotate[0]}},rotateY:{set:function(t){r.setRotate([0,t,0])},get:function(){return r._rotate[1]}},rotateZ:{set:function(t){r.setRotate([0,0,t])},get:function(){return r._rotate[2]}},color:{set:function(t){r.setColor(t)},get:function(){return r._color}},scale:{set:function(t){r.setScale(t)},get:function(){return r._scale}},opacity:{set:function(t){r.setOpacity(t)},get:function(){return r._opacity}},position:{set:function(t){r.setPosition(t)},get:function(){return r._position}},translate:{set:function(t){r.setTranslate(t)},get:function(t){return r._translate}}}),i}return r(t,[{key:"setRotate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0];this._rotate=i.U.isArray(t)?t:[parseFloat(t),0,0];var e="jsi.thing.style.rotate('"+this.id+"', '"+i.U.toJson(this._rotate)+"')";a.Ddd.run(e)}},{key:"setColor",value:function(t){if(this._color!=t){this._color=t;var e="jsi.thing.style.color('"+this.id+"', '"+i.U.toJson(i.U.color(this._color))+"')";a.Ddd.run(e)}}},{key:"setScale",value:function(t){if(this._scale!=t){this._scale=t;var e="jsi.thing.style.scale('"+this.id+"', '"+i.U.toJson(this._scale)+"')";a.Ddd.run(e)}}},{key:"setOpacity",value:function(t){if(this._opacity!=t){this._opacity=t;var e="jsi.thing.style.opacity('"+this.id+"', "+this._opacity+")";a.Ddd.run(e)}}},{key:"setPosition",value:function(t){if(this._position!=t){this._position=t;var e="jsi.thing.style.position('"+this.id+"', '"+i.U.toJson(this._position)+"')";a.Ddd.run(e)}}},{key:"setTranslate",value:function(t){if(this._translate!==t){this._translate=t;var e="jsi.thing.style.translate('"+this.id+"', '"+i.U.toJson(t)+"')";a.Ddd.run(e)}}}]),t}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.LineStyle=void 0;var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),i=n(0),a=n(1);e.LineStyle=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,t),this.id=e,this._color=n.color,this._width=n.width,this._texBundleID=n.texBundleID,this._texTiling=n.texTiling,this._texOffSet=n.texOffSet;var r=this,i={};return Object.defineProperties(i,{color:{set:function(t){r.setColor(t)},get:function(){return r._color}}}),i}return r(t,[{key:"setColor",value:function(t){if(this._color!=t){this._color=t;var e="jsi.line.style.color('"+this.id+"', '"+i.U.toJson(i.U.color(this._color))+"')";a.Ddd.run(e)}}}]),t}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.PipeLine=void 0;n(0);var a=n(3);e.PipeLine=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return o(this,e),r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return i(e,a.Line),e}()},function(t,e,n){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.ArrowLine=void 0;n(0);var a=n(3);e.ArrowLine=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return o(this,e),r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return i(e,a.Line),e}()},function(t,e,n){"use strict";n(21),n(22)},function(t,e,n){"use strict";var o=n(0),r=n(1);r.Ddd.extend({cur:function(t){r.Ddd.run("jsi.getlevel(_callback_)",t)},get:function(t,e){var n="jsi.get('"+t+"', _callback_)";r.Ddd.run(n,e)},query:function(t,e){var n="";if(o.U.isString(t)){switch(t.charAt()){case"#":t=t.substr(1).split(","),n="jsi.query('"+o.U.toJson(t)+"', 'id', _callback_)";break;case".":(t=t.split(",")).forEach(function(t,e,n){n[e]=t.substr(1)}),n="jsi.query('"+o.U.toJson(t)+"', 'class', _callback_)";break;default:t=t.split(","),n="jsi.query('"+o.U.toJson(t)+"', 'uid', _callback_)"}}else o.U.isArray(t)?n="jsi.query('"+o.U.toJson(t)+"', 'props', _callback_)":o.U.isObject(t)&&(n="jsi.query('"+o.U.toJson([t])+"', 'props', _callback_)");r.Ddd.run(n,e)},create:function(t,e,n){if(-1===["Thing","Bubble","Text","Line","ArrowLine","PipeLine","Polygon","LongLine","PixelLine"].indexOf(t))return o.U.log("创建的类型不支持！(DddJS)","error");if(e.type=t,!n&&e.hasOwnProperty("complete")&&o.U.isFunction(e.complete)&&(n=e.complete),e.hasOwnProperty("id")&&e.id||(e.id=o.U.id()),e.style&&(e.style.color&&(e.style.color=o.U.color(e.style.color)),e.style.arrowColor&&(e.style.arrowColor=o.U.color(e.style.arrowColor)),e.style.textColor&&(e.style.textColor=o.U.color(e.style.textColor))),e.points){var i=e.points;if(e.tempId=""+function(t){for(var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],n="",o=0;o<10;o++)n+=e[Math.ceil(35*Math.random())];return n}(),i.length>1e3)for(var a=i.length%1e3==0?parseInt(i.length/1e3):parseInt(i.length/1e3)+1,c=0;c<a;c++){var u=1e3*c,s=1e3*c+1e3,l=!1;c==a-1&&(s=i.length,l=!0);var f=i.slice(u,s);e.points=f,e.lazy=!0,e.start=l;var d="jsi.create('"+o.U.toJson(e)+"', _callback_)";r.Ddd.run(d,n)}else{console.log(e);var p="jsi.create('"+o.U.toJson(e)+"', _callback_)";r.Ddd.run(p,n)}}else{var y="jsi.create('"+o.U.toJson(e)+"', _callback_)";r.Ddd.run(y,n)}},destroy:function(t,e){if(!o.U.isString(t))return o.U.log("只允许传递ID字符串！(DddJS)","warn");t=t.split(",");var n="jsi.destroy('"+o.U.toJson(t)+"', _callback_)";r.Ddd.run(n,e)},panel:function(t,e){var n="";if(o.U.isObject(t)){if(!t.hasOwnProperty("url")||!t.url)return o.U.log("加载第三方面板必须传递 url 属性！(DddJS)","error");if(t.hasOwnProperty("click"))for(var i in t.click){var a=Object.keys(r.Ddd.cach).length;r.Ddd.cach[a]=t.click[i],t.click[i]=a}n="jsi.panel.load("+o.U.toJson(t)+");"}else("Level"===t||o.U.isArray(t)&&-1!==t.indexOf("Level"))&&(n+="jsi.panel.show('LevelPanel', "+(e||!1)+");"),("Prompt"===t||o.U.isArray(t)&&-1!==t.indexOf("Prompt"))&&(n+="jsi.panel.show('PromptPanel', "+(e||!1)+");"),("Switch"===t||o.U.isArray(t)&&-1!==t.indexOf("Switch"))&&(n+="jsi.panel.show('Switch3DPanel', "+(e||!1)+");");r.Ddd.run(n)},click:function(t,e){var n='jsi.on("click", _callback_)';t&&e&&(n='jsi.on("click", '+t+",_callback_)"),"[object Function]"===Object.prototype.toString.call(t)&&(e=t),r.Ddd.run(n,e)},on:function(t,e,n){var o="jsi.on('"+t+"', _callback_)";e&&n&&(o="jsi.on('"+t+"', '"+e+"', _callback_)"),"[object Function]"===Object.prototype.toString.call(e)&&(n=e),r.Ddd.run(o,n)},off:function(t,e){var n="jsi.off('"+t+"')";"[object Function]"===Object.prototype.toString.call(e)&&(callback=e),e&&(n="jsi.off('"+t+"', '"+e+"')"),r.Ddd.run(n)},miniMapOpen:function(t){console.log(t);var e=void 0;e=t?"jsi.eagleShow.openMini()":"jsi.eagleShow.closeMini()",r.Ddd.run(e)}})},function(t,e,n){"use strict";var o=n(1);o.Ddd.mount=function(){o.Ddd.run('jsi.mount("buildings", _callback_)',function(){}),o.Ddd.run('jsi.mount("cam", _callback_)',function(){})}}]));